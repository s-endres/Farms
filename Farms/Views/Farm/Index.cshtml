
@{
    ViewBag.Title = "Farms";
}

<h2>Farms</h2>

<!-- MetisMenu CSS -->
<link href="/bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
<!-- DataTables CSS -->
<link href="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css" rel="stylesheet">
<!-- DataTables Responsive CSS -->
<link href="/bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet">
<!-- Custom Fonts -->
<link href="/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
<script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- DataTables JavaScript -->
<script src="/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>
<!-- Summernote -->
<link href="/bower_components/summernote/css/summernote.css" rel="stylesheet" type="text/css">
<script src="/bower_components/summernote/js/summernote.min.js"></script>
<style>
    .hiddenClass {
        display: none
    }

    .glyphicon:hover {
        cursor: pointer;
    }

    .Error {
        border: solid 1px red;
    }
</style>

<script>
    $(document).ready(function () {
        $SummerNote = $('#Description').summernote({
            height: 150
        });

        $.get('http://localhost:56892/Farm/GetAllFarms', function (data) {
            for (var i = 0; i < data.length; i++) {
                data[i].Hand = "<span class='glyphicon glyphicon-hand-right'></span>"
                data[i].Buttons = "<span class='glyphicon glyphicon-remove-circle'>|</span><span class='glyphicon glyphicon-ok-circle'>|</span><span class='glyphicon glyphicon-eye-open'></span>";
            }
            $table = $('#myTable').DataTable({
                "processing": true,
                "data": data,
                "columns": [
                    { "data": "Hand" },
                    { "data": "Id" },
                    { "data": "Name" },
                    { "data": "Description" },
                    { "data": "Buttons" }
                ],
                responsive: true,
                "order": [[1, "asc"]],
                "columnDefs": [
                    {
                        "targets": [0, 4],
                        "orderable": false
                    }
                ]
            });
        });

        $('#btnAdd').click(function () {
            ButtonChange(true);
        });

        $('#myModal').on('hidden.bs.modal', function () {
            $('#myModal .validation').val("");
            $SummerNote.code("");
            $("#myModal .alert").remove();
        });

        $('#btnCreate').click(function () {
            if (validateInputs() && validateTextArea()) {
                $.ajax({
                    type: "POST",
                    url: "http://localhost:56892/Farm/AddFarm",
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify({
                        Name: $("#Name").val(),
                        Description: $SummerNote.code()
                    }),
                    success: function (data) {
                        if (!data) {
                            AddRemoveModal("Alert", "Error!", "myModal");
                        } else {
                            data.Buttons = "<span class='glyphicon glyphicon-remove-circle'>|</span><span class='glyphicon glyphicon-ok-circle'>|</span><span class='glyphicon glyphicon-eye-open'></span>";
                            data.Hand = "<span class='glyphicon glyphicon-hand-right'></span>";
                            $("#myTable").DataTable().row.add(data).draw();
                            $("#myModal").modal("hide");
                        }
                    },
                    error: function () {
                        AddRemoveModal("Error", "Alert!", "myModal");
                    }
                });
            }
        });

        $('#btnUpdate').click(function () {
            if (validateInputs() && validateTextArea()) {
                $.ajax({
                    type: "PUT",
                    url: "http://localhost:56892/Farm/UpdateFarm",
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify({
                        Id: $("#Id").text(),
                        Name: $("#Name").val(),
                        Description: $SummerNote.code()
                    }),
                    success: function (data) {
                        if (!data) {
                            AddRemoveModal("Alert", "Error!", "myModal");
                        } else {
                            data.Buttons = "<span class='glyphicon glyphicon-remove-circle'>|</span><span class='glyphicon glyphicon-ok-circle'>|</span><span class='glyphicon glyphicon-eye-open'></span>";
                            data.Hand = "<span class='glyphicon glyphicon-hand-right'></span>";
                            $table.row($("#hidden").val()).data(data).draw();
                            $("#myModal").modal("hide");
                        }
                    },
                    error: function () {
                        AddRemoveModal("Error", "Alert!", "myModal");
                    }
                });
            }
        });

        $('#btnDelete').click(function () {
            $.ajax({
                type: "DELETE",
                url: "http://localhost:56892/Farm/RemoveFarm",
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({
                    farmId: $("#IdDelete").text()
                }),
                success: function (data) {
                    if (!data) {
                        AddRemoveModal("Alert", "Error!", "modalDelete");
                    } else {
                        $table.row($("#hiddenDelete").val()).remove().draw();
                        $("#modalDelete").modal("hide");
                    }
                },
                error: function () {
                    AddRemoveModal("Error", "Alert!", "modalDelete");
                }
            });
        });
    });

    function ButtonChange(create) {
        if (create) {
            $("#btnCreate").css("display", "inline");
            $("#btnUpdate, #Id").css("display", "none");
        } else {
            $("#btnUpdate, #Id").css("display", "inline");
            $("#btnCreate").css("display", "none");
        }
        $('#myModal').modal('show');
    }

    $(document).on("click", ".glyphicon-ok-circle", function () {
        var Parent = $(this).parents("tr");
        ButtonChange(false);
        var index = $("#myTable").DataTable().row(Parent).index();
        var Obj = $("#myTable").DataTable().row(index).data();
        $("#Name").val(Obj.Name);
        $SummerNote.code(Obj.Description);
        $("#Id").text(Obj.Id);
        $("#hidden").val(index);
    });

    $(document).on("click", ".glyphicon-remove-circle", function () {
        var Parent = $(this).parents("tr");
        $("#IdDelete").text($table.row(Parent).data().Id);
        $("#hiddenDelete").val($table.row(Parent).index());
        $("#modalDelete").modal('show');
    });

    $(document).on("click", ".glyphicon-eye-open", function () {
        var Parent = $(this).parents("tr");
        window.location.replace("http://localhost:56892/Parcel?IdFarm=" + $table.row(Parent).data().Id);
    });

    function validateInputs() {
        var validate = true;
        $('#myModal .validation').each(function () {
            if ($(this).val().trim() == "") {
                $(this).addClass("Error");
                validate = false;
            } else {
                $(this).removeClass("Error");
            }
        });
        return validate;
    }

    function AddRemove(idAdd, Text) {
        if (!$("#" + idAdd).length) {
            $(".alert").remove();
            $(".form-horizontal").prepend('<div class="alert alert-danger" id="' + idAdd + '"><strong>Warning! </strong>' + Text + '</div >');
        }
    }

    function AddRemoveModal(idAdd, Text, idModal) {
        if (!$("#" + idAdd).length) {
            $("#" + idModal +" .alert").remove();
            $("#" + idModal +" .modal-body").prepend('<div class="alert alert-danger" id="' + idAdd + '"><strong>Warning! </strong>' + Text + '</div >');
        }
    }

    function validateTextArea() {
        console.log($SummerNote.code());
        if ($SummerNote.code() == "<p><br></p>" || $SummerNote.code().trim() == "") {
            AddRemoveModal("DescriptionAlert", "Empty description", "myModal");
            return false;
        }
        return true;
    }

    $(document).on('click', '.glyphicon-hand-right, .glyphicon-hand-down', function () {
        var tr = $(this).parents('tr');
        var row = $table.row(tr);
        if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass('shown');
            ChangeIcon(this, 'glyphicon-hand-right', 'glyphicon-hand-down');
        } else {
            //row.child(format(row.data().Authors)).show();
            getParcels(row);
            tr.addClass('shown');
            ChangeIcon(this, 'glyphicon-hand-down', 'glyphicon-hand-right');
        }
    });

    function format(data) {
        var Table = '<table width="100%"><thead><tr><th>Parcel</th><th>Count</th></tr></thead><tbody>'
        for (var i = 0; i < data.length; i++) {
            Table += '<tr><td>' + data[i].Parcel + '</td><td>' + data[i].Count + '</td></tr>';
        }
        return Table + '</tbody></table>';
    }

    function formatError() {
        return '<div class="alert alert-info"><strong>Info!</strong> Empty table.</div>'
    }

    function ChangeIcon(Element, add, remove) {
        $(Element).addClass(add);
        $(Element).removeClass(remove);
    }

    function getParcels(row) {
        $.ajaxSetup({ async: false })
        $.ajax({
            type: "GET",
            url: "http://localhost:56892/Parcel/GetAllParcelByFarmId",
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            data: { farmId: row.data().Id },
            success: function (data) {
                if (data.length > 0) {
                    var Array = [];
                    for (var i = 0; i < data.length; i++) {
                        var Id = data[i].Id;
                        var Obj = {
                            Parcel: data[i].Description
                        }
                        $.get('http://localhost:56892/Plant/GetAllPlantsByParcelId', { parcelId: Id }, function (plantData) {
                            Obj.Count = plantData.length;
                        });
                        Array.push(Obj);
                    }
                    row.child(format(Array)).show();
                } else {
                    row.child(formatError()).show();
                }
            },
            error: function () {

            }
        });
    }
</script>

<table id="myTable" class="table table-striped table-bordered">
    <thead>
        <tr>
            <td></td>
            <td>Id</td>
            <td>Name</td>
            <td>Description</td>
            <td>Buttons</td>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<button type="button" class="btn btn-info btn-lg" id="btnAdd">Add</button>
<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Modal Header</h4>
            </div>
            <div class="modal-body">
                <label id="Id"></label>
                <div class="form-group">
                    <label for="Name">Name:</label>
                    <input type="text" class="form-control validation" id="Name">
                </div>
                <div class="form-group">
                    <label for="Description">Description:</label>
                    <textarea id="Description"></textarea>
                </div>
                <input type="text" class="hiddenClass" id="hidden">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-default" id="btnCreate">Create</button>
                <button type="button" class="btn btn-default" id="btnUpdate">Update</button>
            </div>
        </div>

    </div>
</div>

<div id="modalDelete" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Delete</h4>
            </div>
            <div class="modal-body">
                <p>Do you really want to delete the farm <span id="IdDelete"></span>?<p>
                    <input type="text" class="hiddenClass" id="hiddenDelete">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-default" id="btnDelete">Delete</button>
            </div>
            <div class="modal-footer">

            </div>
        </div>

    </div>
</div>