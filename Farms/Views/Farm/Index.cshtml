@{
    ViewBag.Title = "Farms";
}

<h2>Farms</h2>
<!DOCTYPE html>
<html>
<head>
    <!-- MetisMenu CSS -->
    <link href="/bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css" rel="stylesheet">
    <!-- DataTables Responsive CSS -->
    <link href="/bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- DataTables JavaScript -->
    <script src="/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>
    <link href="/bower_components/select2/css/select2.min.css" rel="stylesheet" type="text/css">
    <script src="/bower_components/select2/js/select2.min.js"></script>
    <!-- Summernote -->
    <link href="/bower_components/summernote/css/summernote.css" rel="stylesheet" type="text/css">
    <script src="/bower_components/summernote/js/summernote.min.js"></script>
</head>
<body>
    <script>
        $("document").ready(function () {

            $SummerNote = $("#Summernote").summernote({
                height: 125,
                codemirror: { theme: 'monokai' }
            });//Inicialize the Text Area

            $.ajax({
                type: "GET",
                url: "http://localhost:56892/Farm/GetAllFarms",
                data: "",
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (pData) {


                    //for (var i = 0; i < pData.length; i++) {
                    //    pData[i].ShowMore = "<span class='glyphicon glyphicon-download' class='Shown'></span>";
                    //    pData[i].Buttons = "<span class='glyphicon glyphicon-remove-circle'></span> |" + " <span class='glyphicon glyphicon-ok-circle'></span> |" + " <span class='glyphicon glyphicon-unchecked'></span>";
                    //}

                    $Table = $("#MainTable").DataTable({
                        "processing": true,
                        "data": pData,
                        "columns": [
                            { "defaultContent": "<span class='glyphicon glyphicon-download' class='Shown'></span>"},
                            { "data": "Id" },
                            { "data": "Name" },
                            { "data": "Description" },                            
                            { "defaultContent": "<span class='glyphicon glyphicon-remove-circle'></span> |" + " <span class='glyphicon glyphicon-ok-circle'></span> |" + " <span class='glyphicon glyphicon-unchecked'></span>" }
                        ],
                        responsive: true,
                        "columnDefs":
                        [
                            {
                                "targets": [0, 4],
                                "sortable": false
                            }
                        ],
                        "order": [[1, "asc"]],

                    });//Inicialize the Data Table

                },
                error: function () {
                    WarningMessage();
                }
            });//Close AJAX GET

            $("#EditRow").click(function () {

                
                ObjEdit = {
                    ShowMore: "<span class='glyphicon glyphicon-download' class='Shown'>",
                    Id: $("#Id").val(),
                    Name: $("#Name").val(),
                    Description: $SummerNote.code(),
                    Buttons: "<span class='glyphicon glyphicon-remove-circle'></span> |" + " <span class='glyphicon glyphicon-ok-circle'></span> |" + " <span class='glyphicon glyphicon-unchecked'></span>"
                };
                if (ValidateForm(".modal-body") && ValidateTextArea()) {
                    $.ajax({
                        type: "PUT",
                        url: "http://localhost:56892/Farm/UpdateFarm",
                        data: JSON.stringify(ObjEdit),
                        dataType: "json",
                        contentType: 'application/json; charset=utf-8',
                        success: function (pData) {
                            $Table
                              .row($("#hidden").val())
                              .data(ObjEdit)
                              .draw();
                            CloseModal();


                        },
                        error: function () {
                            console.log("Jaja Salu2");
                            WarningMessage();
                        }
                    });//Close AJAX PUT For Edit
                }
            });//Edit Function

            $("#AddFarm").click(function () {
                if (ValidateTextArea() && ValidateForm()) {
                $.ajax({
                    type: "POST",
                    url: "http://localhost:56892/Farm/AddFarm",
                    data: JSON.stringify({
                        Name: $("#Name").val(),
                        Description: $SummerNote.code(),
                        
                    }),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (pData) {
                        var ObjPostData = {                            
                            Id: pData.Id,
                            Name: $("#Name").val(),
                            Description: $SummerNote.code(),
                           
                        }
                        
                        $Table
                            .row
                            .add(ObjPostData)
                            .draw();
                        CloseModal();
                    },
                    error: function () {

                    }
                    });//Close AJAX POST

                }//Close Validation

            });//Close Add function

            $("tbody").on("click", ".glyphicon-ok-circle", function () {
                $(".alert-danger").remove();
                $(".NewOne").removeClass("Error");
                $("#myModal").modal();
                $("#AddFarm").css("display", "none");
                $("#EditRow").css("display", "inline");

                var Row = $(this).parents("tr");
                var Index = $Table.row(Row).index();
                var Data = $Table.row(Index).data();

                $("#Id").val(Data.Id);
                $("#Name").val(Data.Name);
                $SummerNote.code(Data.Description);
                $("#hidden").val(Index);

            });//Opens the edit Modal

            $("tbody").on("click", ".glyphicon-remove-circle", function () {
                var Row = $(this).parents("tr");
                var Index = $Table
                    .row(Row)
                    .index();
                $("#hidden").val(Index);
                //$("#myModal").modal();
                var Index2 = $("#hidden").val();

                $("#hidden2").val(Index);
                $("#myDeleteModal").modal();


            });//Obtains the index value of the row for the Delete

            $("#YesDelete").click(function () {

                ObjDelete = { farmId: $Table.row($("#hidden2").val()).data().Id }
                console.log(ObjDelete);
                $.ajax({
                    type: "DELETE",
                    url: "http://localhost:56892/Farm/RemoveFarm",
                    data: JSON.stringify({ farmId: $Table.row($("#hidden2").val()).data().Id }),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (Data) {

                        if (Data) {
                            $Table.row($("#hidden2").val()).remove().draw();
                            $("#myDeleteModal").modal("hide");
                        }
                        else {
                            if (!$('div[class="alert-danger"]').length) {
                                $("#MainTable").prepend('<div class="alert alert-danger">< strong > Omaiga!</strong >Failed deleting the row ToT</div >');
                            }
                        }
                    },
                    error: function () {
                        WarningMessage();
                    }
                });//Close Delete Ajax
            })//Confirmation Modal Delete;

            $("#NoDelete").click(function () {
                $("#myDeleteModal").modal("hide");
            });//Confirmation Modal

            $("tbody").on("click", ".glyphicon-unchecked", function () {
                var Row = $(this).parents("tr");
                IdVal = $Table.row(Row).data().Id;
                window.location.replace("http://localhost:56892/Parcel?farmId=" + IdVal);
            });

            $("#MainTable tbody").on("click", ".glyphicon-download,.glyphicon-upload", function () {
                var RClass = "glyphicon-download";
                var AClass = "glyphicon-upload";

                var Tr = $(this).closest("tr");/**HTML Row**/
                var row = $Table.row(Tr);/**DataTable Row**/
                var Index = $Table.row(row).index();


                if (row.child.isShown()) {
                    ShowLogo(this, AClass, RClass);
                    row.child.hide();
                    Tr.removeClass('shown');
                }
                else {
                    var GetFarmObject = { farmId: $Table.row(Index).data().Id };
                    $.ajaxSetup({ async: false });
                    $.ajax({
                        type: "GET",
                        url: "http://localhost:56892/Parcel/GetAllParcelByFarmId",
                        data: GetFarmObject,
                        dataType: "json",
                        contentType: 'application/json; charset=utf-8',
                        success: function (pData) {

                            if (!pData) {
                                console.log("Didnt Worked :(");
                            }
                            else {
                                var TableRows = "";
                                $.each(pData, function () {

                                    var ParcelObjectId = { parcelId: this.Id };
                                    console.log(this.Id);
                                    var Description = this.Description;
                                    console.log(Description);
                                    
                                    $.ajax({
                                        type: "GET",
                                        url: "http://localhost:56892/Plant/GetAllPlantsByParcelId",
                                        data: ParcelObjectId,
                                        dataType: "json",
                                        contentType: 'application/json; charset=utf-8',
                                        success: function (Data) {

                                            TableRows += "<tr><td>" + Description + "</td>" + "<td>" + Data.length + "</td></tr>";
                                            
                                        },
                                        error: function () {
                                        }
                                    });
                                });//Close GET Plant Count Ajax

                                row.child(Format(TableRows)).show();
                            }

                        },
                        error: function () {
                            alert("it isnt working >:(");
                        }
                    });//Close GET Description Ajax
                    ShowLogo(this, RClass, AClass);


                }


            });//Close Show More Function


        });//Close Document Ready

        /*********************************************FUNCTIONS AREA**********************************************/
        function OpenModal() {
            $("#myModal").modal();           
            $("#EditRow").css("display", "none");
            $("#AddFarm").css("display", "inline");
            $("#Id").css("display", "none");
            $(".modal-content .form-control").not(".hidden").not(".hidden2").val("");
            $SummerNote.code("");
            $(".IdDiv").css("display", "none");
            $(".alert-danger").remove()
        }//Opens the modal

        function CloseModal() {
            $("#myModal").modal("hide");
        }//Closes the modal

        function WarningMessage() {
            if (!$('div[class="alert-danger"]').length) {
                $("#myModal").prepend('<div class="alert alert-danger">< strong > Omaiga!</strong >Something went wrong >:O</div >');
            }
        }//Close Warning Message function

        function Format(Row) {

            var Table = "<table><thead><tr><th>Parcel:</th><th>Plant Count:</th></tr></thead><tbody>" + Row + "</tbody></table>";


            return Table;

        }//Adds a format to the sent data

        function ShowLogo(pSelector, pRClass, pAClass) {
            $(pSelector).removeClass(pRClass);
            $(pSelector).addClass(pAClass);
        }//Swaps the icon of the show more row

        function ValidateForm() {
            var Error = true;           
            if ($(".ClassName").val().trim() === "") {
                $(".ClassName").addClass("Error");
                    Error = false;
                }
                else {
                    $(this).removeClass("Error");
                }
            
            return Error;
        }//Close Validation function

        function ValidateTextArea() {
            if ($SummerNote.val().trim() === "") {
                $(".ValidationModal").prepend('<div class="alert alert-danger"><strong>Omaiga!</strong> You can insert a farm without a description >:v</div>');
                return false;
            }
            return true;
        }//Validates the text Area

    </script>
    <style>
        #hidden {
            display: none;
        }

        #hidden2 {
            display: none;
        }
          .Error {
        border: solid 1px red;
    }
    </style>


    <!------------------------------------------MAIN TABLE------------------------------------------>
    Add Row | <span><button id="AddRowModal" class="btn btn-success btn btn-default glyphicon glyphicon-plus-sign" type="button" onclick="OpenModal()"></button></span>
    <table id="MainTable" class="table table-striped table-bordered" cellspacing="0">
        <thead>
            <tr>
                <th>
                    <label>Show More</label>
                </th>
                <th>
                    <label>ID</label>
                </th>
                <th>
                    <label>Name</label>
                </th>
                <th>
                    <label>Description</label>
                </th>
                <th>
                    <label>Buttons</label>
                </th>
            </tr>
        <tbody></tbody>
        </thead>
    </table>
    <!------------------------------------------MAIN TABLE------------------------------------------>
    <!------------------------------------------MODAL------------------------------------------>
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header" style="padding:35px 50px;">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4><span class="glyphicon glyphicon-add"></span> Add Farm Information :3</h4>
                </div>
                <div class="modal-body ValidationModal" id="modal-body" style="padding:40px 50px;">

                    <form role="form">

                        <div class="form-group IdDiv">
                            <label for="usrname"><span class="glyphicon glyphicon-user"></span> Id</label>
                            <input type="text" class="form-control NewOne" id="Id" readonly>
                        </div>


                        <div class="form-group">
                            <label for="usrname"><span class="glyphicon glyphicon-user"></span> Name</label>
                            <input type="text" class="form-control ClassName" id="Name" placeholder="Enter First Value">
                        </div>
                        <div class="form-group">
                            <label for="usrname"><span class="glyphicon glyphicon-user"></span> Description</label>
                            <textarea id="Summernote" required></textarea>
                        </div>
                        <input type="text" id="hidden">
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success btn-block" id="AddFarm"><span class="glyphicon glyphicon-record"></span> Add the Farm</button>
                    <button type="submit" class="btn btn-success btn-block Display" id="EditRow"><span class="glyphicon glyphicon-record"></span> Edit the row</button>
                    <button type="submit" class="btn btn-success btn-block" id="CloseModal" onclick="CloseModal()"><span class="glyphicon glyphicon-remove-circle"></span> Cancel </button>
                </div>
            </div>


        </div>
    </div>
    <!------------------------------------------MODAL------------------------------------------>
    <!------------------------------------DELETE MODAL------------------------------------->
    <div class="modal fade" id="myDeleteModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header" style="padding:35px 50px;">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4><span class="glyphicon glyphicon-add"></span>Delete this row ????</h4>
                </div>
                <div class="modal-body" style="padding:40px 50px;">
                    <div class="alert alert-danger"><strong> Mah gosh </strong>Do you really want to delete this ??</div>
                </div>
                <input id="hidden2" type="text">
                <div class="modal-footer">

                    <button type="submit" class="btn btn-success btn-block Display" id="YesDelete"><span class="glyphicon glyphicon-record"></span>Yes, i want to delete this</button>
                    <button type="submit" class="btn btn-success btn-block" id="NoDelete"><span class="glyphicon glyphicon-remove-circle"></span>No, it was a mistake</button>
                </div>
            </div>


        </div>
    </div>
    <!------------------------------------DELETE MODAL------------------------------------->
    </div>
</body>
</html>




