
@{
    ViewBag.Title = "Edit";
}
<h2>Edit</h2>


@{
    ViewBag.Title = "Create";
}
<!-- MetisMenu CSS -->
<link href="/bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
<!-- DataTables CSS -->
<link href="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css" rel="stylesheet">
<!-- DataTables Responsive CSS -->
<link href="/bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet">
<!-- Custom Fonts -->
<link href="/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
<!-- DataTables JavaScript -->
<script src="/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>

<link href="/bower_components/select2/css/select2.min.css" rel="stylesheet" type="text/css">
<script src="/bower_components/select2/js/select2.min.js"></script>

<!-- Summernote -->
<link href="/bower_components/summernote/css/summernote.css" rel="stylesheet" type="text/css">
<script src="/bower_components/summernote/js/summernote.min.js"></script>

<style>
    .hiddenClass {
        display: none
    }

    .glyphicon:hover {
        cursor: pointer;
    }

    .Error {
        border: solid 1px red;
    }
</style>

<script>
    $(document).ready(function () {
        $.urlParam = function (name) {
            var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
            return results[1] || 0;
        }

        $SummerNote = $('#Description').summernote({
            height: 150
        });

        $SummerNote2 = $('#Description2').summernote({
            height: 150
        });

        $("#Select2").select2({
            placeholder: "Select conditions",
            allowClear: true
        });

        $.get('http://localhost:56892/Parcel/GetAllConditions', function (data) {
            for (var i = 0; i < data.length; i++) {
                $("#Select2").append('<option value="' + data[i].Id + '">' + data[i].Name + '</option>');
            }
        });

        $.get("http://localhost:56892/Parcel/GetParcel", { parcelId: $.urlParam("parcelId") }, function (data) {
            console.log(data);
            $("#Size").val(data.Size);
            $SummerNote.code(data.Description);
            $("#Select2").val(data.ConditionIds).trigger('change');
            $("#hiddenFarmId").val(data.IdFarm)
            if (data.Observations == null) {
                $table = $('#myTable').DataTable({
                    responsive: true,
                    "columnDefs": [
                        {
                            "targets": [1],
                            "orderable": false
                        }
                    ],
                    "columns": [
                        { "data": "Description" },
                        { "data": "Buttons" }
                    ]
                });
            } else {
                for (var i = 0; i < data.Observations.length; i++) {
                    data.Observations[i].Buttons = "<span class='glyphicon glyphicon-remove-circle'> | </span><span class='glyphicon glyphicon-ok-circle'></span>";
                }
                $table = $('#myTable').DataTable({
                    responsive: true,
                    "columnDefs": [
                        {
                            "targets": [1],
                            "orderable": false
                        }
                    ],
                    data: data.Observations,
                    "columns": [
                        { "data": "Description" },
                        { "data": "Buttons" }
                    ]
                });
            }
            
        });

        $('#btnAdd').click(function () {
            ButtonChange(true);
        });

        $("#btnDelete").click(function () {
            $("#modalDelete").modal("toggle");
            var Index = $table.row($("#deleteHidden").val());
            Index.remove().draw();
        });

        $('#btnCreate').click(function () {
            if ($SummerNote2.code() == "<p><br></p>" || $SummerNote2.code() == "") {
                AddRemoveModal("DescriptionAlert", "Empty description", "myModal");
            } else {
                var Data = {
                    Description: $SummerNote2.code(),
                    Buttons: "<span class='glyphicon glyphicon-remove-circle'> | </span><span class='glyphicon glyphicon-ok-circle'></span>"
                };
                $("#myTable").DataTable().row.add(Data).draw();
                $("#myModal").modal("hide");
            }
        });

        $('#myModal').on('hidden.bs.modal', function () {
            $('#myModal input[class="form-control"]').val("");
            $SummerNote2.code("");
            $("#myModal .alert").remove();
        });

        $("#btnSave").click(function () {
            if (Validate() && ValidateTable()) {
                var Arreglo = [];
                $table.rows().every(function () {
                    Arreglo.push({
                        Id: this.index(),
                        Description: this.data().Description
                    });
                });
                $.ajax({
                    type: "PUT",
                    url: "http://localhost:56892/Parcel/UpdateParcel",
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify({
                        Id: $.urlParam("parcelId"),
                        Size: $("#Size").val(),
                        Description: $SummerNote.code(),
                        IdFarm: $("#hiddenFarmId").val(),
                        Observations: Arreglo,
                        ConditionIds: $("#Select2").val()
                    }),
                    success: function (data) {
                        if (!data) {
                            AddRemove("Alert", "Error!");
                        } else {
                            window.location.replace("http://localhost:56892/Parcel?IdFarm=" + $("#hiddenFarmId").val());
                        }
                    },
                    error: function () {
                        AddRemove("Error", "Alert!");
                    }
                });
            }
        });
    });

    function ButtonChange(create) {
        if (create) {
            $("#btnCreate").css("display", "inline");
            $("#btnUpdate").css("display", "none");
        } else {
            $("#btnUpdate").css("display", "inline");
            $("#btnCreate").css("display", "none");
        }
        $('#myModal').modal('show');
    }

    $(document).on("click", ".glyphicon-remove-circle", function () {
        var Parent = $(this).parents("tr");
        $("#deleteHidden").val($table.row(Parent).index());
        $("#modalDelete").modal('show');
    });

    $(document).on("click", ".glyphicon-ok-circle", function () {
        var Parent = $(this).parents("tr");
        ButtonChange(false);
        $SummerNote2.code(($table.row(Parent).data().Description));
        $("#hidden").val($table.row(Parent).index());
    });

    $(document).on("click", "#btnUpdate", function () {

        if ($SummerNote2.code() == "<p><br></p>" || $SummerNote2.code() == "") {
            AddRemoveModal("DescriptionAlert", "Empty description", "myModal");
        } else {
            var idx = $("#hidden").val();
            var Obj = {
                Description: $SummerNote2.code(),
                Buttons: "<span class='glyphicon glyphicon-remove-circle'> | </span><span class='glyphicon glyphicon-ok-circle'></span>"
            };
            $("#myTable").DataTable().row(idx).data(Obj).draw();
            $("#myModal").modal("hide");
        }
    });

    function AddRemove(idAdd, Text) {
        if (!$("#" + idAdd).length) {
            $(".alert").remove();
            $(".form-horizontal").prepend('<div class="alert alert-danger" id="' + idAdd + '"><strong>Warning! </strong>' + Text + '</div >');
        }
    }

    function ValidateTable() {
        if ($table.data().length == 0) {
            AddRemove("Table", "Please add observations");
            return false;
        }
        return true;
    }

    function AddRemoveModal(idAdd, Text, idModal) {
        if (!$("#" + idAdd).length) {
            $("#" + idModal + " .alert").remove();
            $("#" + idModal + " .modal-body").prepend('<div class="alert alert-danger" id="' + idAdd + '"><strong>Warning! </strong>' + Text + '</div >');
        }
    }

    function Validate() {
        var validate = true;
        if ($("#Size").val() == "" || $("Size").val() <= 0) {
            validate = false;
            $("#Size").addClass("Error")
        } else {
            $("#Size").removeClass("Error")
        }
        if ($SummerNote.code() == "<p><br></p>" || $SummerNote.code() == "") {
            validate = false;
            AddRemove("SummerNoteError", "Empty Description");
        }
        if ($("#Select2").val() == null) {
            validate = false;
            AddRemove("SelectError", "Without conditions");
        }
        return validate;
    }
</script>

<div class="form-horizontal">
    <h4>Parcel</h4>
    <hr />
    <div class="form-group">
        <label class="control-label col-md-2">Size</label>
        <div class="col-md-10">
            <input type="number" class="form-control" id="Size" />
        </div>
    </div>

    <div class="form-group">
        <label class="control-label col-md-2">Description</label>
        <div class="col-md-10">
            <textarea id="Description" class="summernote"></textarea>
        </div>
    </div>

    <div class="form-group">
        <label class="control-label col-md-2">Conditions</label>
        <div class="col-md-10">
            <select id="Select2" class="form-control" multiple></select>
        </div>
    </div>
</div>

<table id="myTable" width="100%">
    <thead>
        <tr>
            <th>Description</th>
            <th>Buttons</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
<button type="button" class="btn btn-info btn-lg" id="btnAdd">Add observation</button>
<div class="form-group">
    <div class="col-md-offset-2 col-md-10">
        <input type="text" class="hiddenClass" id="hiddenFarmId" />
        <input type="button" id="btnSave" value="Save" class="btn btn-default" />
    </div>
</div>

<div id="myModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content myForm">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Modal Header</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="Description2">Description:</label>
                    <textarea id="Description2"></textarea>
                </div>
                <input type="text" class="hiddenClass" id="hidden">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-default" id="btnCreate">Create</button>
                <button type="button" class="btn btn-default" id="btnUpdate">Update</button>
            </div>
        </div>

    </div>
</div>

<div id="modalDelete" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Delete</h4>
            </div>
            <div class="modal-body">
                <p>Do you really want to delete this?<p>
                    <input type="text" class="hiddenClass" id="deleteHidden">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-default" id="btnDelete">Delete</button>
            </div>
            <div class="modal-footer">

            </div>
        </div>

    </div>
</div>