
@{
    ViewBag.Title = "Edit";
}
<!-- Select2 -->
<script src="/bower_components/select2/js/select2.min.js"></script>
<link href="/bower_components/select2/css/select2.min.css" rel="stylesheet" type="text/css">
<!-- Summernote -->
<link href="/bower_components/summernote/css/summernote.css" rel="stylesheet" type="text/css">
<script src="/bower_components/summernote/js/summernote.min.js"></script>
<!-- Custom Fonts -->
<link href="/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<script>
    $(document).ready(function () {
        $.urlParam = function (name) {
            var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
            return results[1] || 0;
        }

        $.get('http://localhost:56892/Parcel/GetAllConditions', function (data) {
            $.each(data,function() {
                $("#Conditions").append("<option value='" + this.Id + "'>" + this.Name + "</option>");
            });
        });

        $('#dataTables-example').DataTable({
            responsive: true
        });

        $.get('http://localhost:56892/Parcel/GetParcel?parcelId=' + $.urlParam('parcelId'), function (data) {

            $("#Size").val(data.Size);
            $summernote.code(data.Description);
            $("#FarmId").val(data.IdFarm);
            $("#Conditions").val(data.ConditionIds).trigger("change"),
                console.log(data.Observations);
            $.each(data.Observations, function () {
                $("#dataTables-example").DataTable().row.add([this.Description,"<span class='glyphicon glyphicon-remove-sign'></span> <span> | </span> " +
                    "<span class='glyphicon glyphicon-ok-sign' onclick='editMyRow(this)'></span>"]).draw();
            });

        });

        $("#Conditions").select2({
            placeholder: "select a value"
        });

        $summernote = $('.summernote').summernote({
            height: 150,   //set editable area's height
            codemirror: { // codemirror options
                theme: 'monokai'
            }
        });

        $("#btnSaveParcel").click(function () {

            var obList = []
            $($("#dataTables-example").DataTable().rows().data()).each(function(index, row) {
                var Observation = {
                    id: index,
                    Description: row[0]
                }
                obList.push(Observation);
            });
            console.log(obList);

            $.ajax({
                type: "PUT",
                url: "http://localhost:56892/Parcel/UpdateParcel",
                data: JSON.stringify({
                    Id: $.urlParam('parcelId'),
                    Size: $("#Size").val(),
                    Description: $summernote.code(),
                    IdFarm: $("#FarmId").val(),
                    Observations: obList,
                    ConditionIds: $("#Conditions").val(),
                }),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    if (data != false) {
                        window.location.replace("http://localhost:56892/Parcel?farmId=" + data.IdFarm);
                    } else {
                        alert('Wops ERROR O.O" ');
                    }
                },
                error: function () {
                    alert('Wops ERROR O.O" ');
                }
            });
        });

    });
</script>

<h2>Edit</h2>


@using (Html.BeginForm())
{

    <div class="form-horizontal">
        <h4>Parcel</h4>
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <div class="form-group">
            <label class="control-label col-md-2">Size</label>
            <div class="col-md-10">
                <input type="number" id="Size" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Description</label>
            <div class="col-md-10">
                <textarea id="Description" class="summernote"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Conditions</label>
            <div class="col-md-10">
                <select id="Conditions" class="form-control" multiple></select>
            </div>
        </div>
    </div>
    <input type="text" class="form-control" style="display:none" id="FarmId">

    <div class="row" style="padding:15px">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Observation |
                    <span class="glyphicon glyphicon-plus-sign" id="addNewRow" data-toggle="modal" data-target="#exampleModal" />

                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <div class="dataTable_wrapper">
                        <table class="table table-striped table-bordered table-hover" id="dataTables-example">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Buttons</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>

    <button type="button" id="btnSaveParcel" class="btn btn-primary">Save</button>
}




<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Add new Row to Table</h4>
            </div>
            <div id="rowModalBody" class="modal-body">
                <form id="modalForm">
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">First input:</label>
                        <input type="text" class="form-control" id="firstInput">
                    </div>
                    <input type="text" class="form-control" style="display:none" id="hiddenValue">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnCancel" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" class="btn btn-primary" onclick="addMyInfo()">Add Row</button>
                <button type="button" id="btnEdit" class="btn btn-primary" style="display:none">Edit</button>
            </div>
        </div>
    </div>
</div>

<!-- DataTables JavaScript -->
<script src="/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>

<script>

    $(document).ready(function () {

        $('#dataTables-example tbody').on('click', '.glyphicon-remove-sign', function () {
            $("#dataTables-example").DataTable()
                .row($(this).parents('tr'))
                .remove()
                .draw();
        });

        $('#exampleModal').on('hidden.bs.modal', function () {
            cleanModalForm();
        });

        $("#btnEdit").on("click", function () {
            var gotError = validateMyForm();
            if (gotError == 0) {
                var index = $("#hiddenValue").val();
                var d = $("#dataTables-example").DataTable()
                    .row(index)
                    .data();

                d[0] = $("#firstInput").val();

                $("#dataTables-example").DataTable()
                    .row(index)
                    .data(d)
                    .draw();

                //Both are need to hide the mode successfully
                $('#exampleModal').modal('hide');
                $('body').removeClass('modal-open');
            }
        })

    });

    function editMyRow(object) {
        var table = $("#dataTables-example").DataTable();
        var myRow = $(object).closest('td').parent()[0];
        var myIndex = table.row(myRow).index();
        var d = table
            .row(myIndex)
            .data();

        $('#exampleModal').modal('show');

        $('#btnEdit').css('display', 'inline');
        $('#btnSave').css('display', 'none');

        $("#firstInput").val(d[0]);
        $("#hiddenValue").val(myIndex);
    };

    function cleanModalForm() {
        $('#btnEdit').css('display', 'none');
        $('#btnSave').css('display', 'inline');
        $("#modalForm div input[type='text']").val("");

        $("#modalForm div input[type='text']").each(function () {
            $(this).parent("div").removeClass("has-error");
        })
    }

    function validateMyForm() {

        var gotError = 0;
        $("#modalForm div input[type='text']").each(function () {
            if ($.trim(this.value) == "") {
                $(this).parent("div").addClass("has-error");
                if (gotError == 0)
                    gotError = 1;
            } else {
                $(this).parent("div").removeClass("has-error");
            }
        })

        return gotError;
    }

    function addMyInfo() { //Como limpiamos este codigo?
        var gotError = validateMyForm();
        if (gotError == 0) {
            //We add the row to the dataTable
            $("#dataTables-example").DataTable().row.add([
                $("#firstInput").val(),
                "<span class='glyphicon glyphicon-remove-sign'></span> <span> | </span> " +
                "<span class='glyphicon glyphicon-ok-sign' onclick='editMyRow(this)'></span>"
            ]).draw();

            //We clean all input fields
            $("#modalForm div input[type='text']").val("");


            //Both are need to hide the mode successfully
            $("#btnCancel").click();
        }
    }

</script>