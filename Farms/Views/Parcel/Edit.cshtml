
@{
    ViewBag.Title = "Edit";
}
<h2>Edit</h2>
<!DOCTYPE html>
<html>
<head>
    <!-- MetisMenu CSS -->
    <link href="/bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css" rel="stylesheet">
    <!-- DataTables Responsive CSS -->
    <link href="/bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- DataTables JavaScript -->
    <script src="/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>
    <link href="/bower_components/select2/css/select2.min.css" rel="stylesheet" type="text/css">
    <script src="/bower_components/select2/js/select2.min.js"></script>
    <!-- Summernote -->
    <link href="/bower_components/summernote/css/summernote.css" rel="stylesheet" type="text/css">
    <script src="/bower_components/summernote/js/summernote.min.js"></script>
</head>
<body>
    <script>
        $("document").ready(function () {


            $SummerNote = $("#Summernote").summernote({
                height: 125,
                codemirror: { theme: 'monokai' }
            });//Inicialize the Text Area

            $Select1 = $("#Select1").select2({
                placeholder: "Select a Condition",
                allowClear: true
            });//Inicialize the select condition

            $SummerNote2 = $("#Summernote2").summernote({
                height: 125,
                codemirror: { theme: 'monokai' }
            });//Inicialize the Text Area

            $.urlParam = function (pName) {
                var results = new RegExp('[\?&]' + pName + '=([^&#]*)').exec(window.location.href);
                return results[1] || 0;
            }

            ParcelObject = { parcelId: $.urlParam("parcelId") };

            $.ajax({
                type: "GET",
                url: "http://localhost:56892/Condition/GetAllConditions",
                data: "",
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (Pdata) {
                    if (Pdata) {
                        $.each(Pdata, function () {

                            $("#Select1").append('<option value="' + this.Id + '">' + this.Name + '</option>');
                        })
                    }
                    else {

                        if (!$('div[class="alert-danger"]').length) {
                            $(".form-group").prepend('<div class="alert alert-danger"><strong>Omaiga!</strong>Something went wrong</div>');
                        }
                    }
                },
                error: function () {
                    WarningMessage();
                }
            });//GET Ajax Conditions


            $.ajax({
                type: "GET",
                url: "http://localhost:56892/Parcel/GetParcel",
                data: ParcelObject,
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (Data) {

                    $("#SizeInput").val(Data.Size);
                    $SummerNote.code(Data.Description);
                    $("#Select1").val(Data.ConditionIds).trigger('change');
                    $("#hidden3").val(Data.IdFarm);
                    console.log(Data.ConditionIds);
                    console.log(Data.Observations);
                    for (var i = 0; i < Data.Observations.length; i++) {
                        Data.Observations[i].Buttons = "<span class='glyphicon glyphicon-remove-circle'></span> |" + " <span class='glyphicon glyphicon-ok-circle'></span>";

                    }
                    $Table = $("#MainTable").DataTable({
                        "processing": true,
                        "data": Data.Observations,
                        "columns": [
                            { "data": "Description" },
                            { "data": "Buttons" }
                        ],
                        responsive: true

                    });//Inicialize the Data Table

                },
                error: function () {
                    WarningMessage();
                }
            });//Close GET Ajax

            $.urlParam = function (pName) {
                var results = new RegExp('[\?&]' + pName + '=([^&#]*)').exec(window.location.href);
                return results[1] || 0;
            }

            $("#AddObservation").click(function () {

                var ObjPostData = {

                    Description: $SummerNote2.code(),
                    Buttons: "<span class='glyphicon glyphicon-remove-circle'></span> |" + " <span class='glyphicon glyphicon-ok-circle'></span>"
                }

                $Table
                    .row
                    .add(ObjPostData)
                    .draw();
                CloseModal();

            });//Adds Observations

            $("#EditParcel").click(function () {

                var pArray = [];
                $.each($Table.rows().data(), function () {
                    var ObjIndex = { Id: this.index, Description: this.Description };
                    pArray.push(ObjIndex);
                });
                if (ValidateTextArea() && ValidateForm() && ValidateSelect()) {
                    $.ajax({
                        type: "PUT",
                        url: "http://localhost:56892/Parcel/UpdateParcel",
                        data: JSON.stringify({
                            Id: $.urlParam("parcelId"),
                            Size: $("#SizeInput").val(),
                            Description: $SummerNote.code(),
                            IdFarm: $("#hidden3").val(),
                            Observations: pArray,
                            ConditionIds: $("#Select1").val()
                        }),
                        dataType: "json",
                        contentType: 'application/json; charset=utf-8',
                        success: function (Pdata) {
                            window.location.replace("http://localhost:56892/Parcel?farmId=" + $("#hidden3").val());
                        },
                        error: function () {
                            WarningMessage();
                        }

                    });//PUT Ajax
                }
            });//Edit Parcel

            $("tbody").on("click", ".glyphicon-ok-circle", function () {
                $("#AddObservation").css("display", "none");
                $("#EditRow").css("display", "inline");

                var Row = $(this).parents("tr");
                var Index = $Table.row(Row).index();
                var Data = $Table.row(Index).data();
                $("#hidden").val(Index);
                $SummerNote2.code(Data[0]);
                $("#myModal").modal();
                console.log($SummerNote2.code());
            });//Print the row data in the modal

            $("#EditRow").click(function () {

                if (ValidateTextAreaModal()) {
                    var ObjEdit = {
                        Description: $SummerNote2.code(),
                        Buttons: "<span class='glyphicon glyphicon-remove-circle'></span> |" + " <span class='glyphicon glyphicon-ok-circle'></span>"
                    };
                    console.log($("#hidden").val());
                    $Table
                        .row($("#hidden").val())
                        .data(ObjEdit)
                        .draw();
                    CloseModal();
                }

            });//Edit Row


        });//Close Document Ready

        /*********************************************FUNCTIONS AREA**********************************************/
        function OpenModal() {
            $("#myModal").modal();
            $("#EditRow").css("display", "none");
            $("#AddFarm").css("display", "inline");
            $("#Id").css("display", "none");
            $(".modal-content .form-control").not(".hidden").not(".hidden2").val("");
            $("#modal-body").remove("alert-danger")
            $SummerNote2.code("");
        }//Opens the modal
        function CloseModal() {
            $("#myModal").modal("hide");
        }//Closes the modal
        function WarningMessage() {
            if (!$('div[class="alert-danger"]').length) {
                $("#MainTable").prepend('<div class="alert alert-danger">< strong > Omaiga!</strong >Something went wrong >:O</div >');
            }
        }//Close Warning Message function

        function ValidateTextArea() {
            if ($SummerNote.code() === "") {
                $(".Form-Class").prepend('<div class="alert alert-danger"><strong>Omaiga!</strong> You can insert a Farm without a description >:v</div>');
                return false;
            }
            return true;
        }//Validates the text Area

        function ValidateTextAreaModal() {
            if ($SummerNote2.code() === "<p><br></p>" || $SummerNote2.code() === "") {
                $(".ValidationModal").prepend('<div class="alert alert-danger"><strong>Omaiga!</strong> You can insert a Farm without description >:3</div>');
                return false;
            }
            return true;
        }//Validates the text Area (MODAL)

        function ValidateForm() {
            var Error = true;
            if ($("#SizeInput").val().trim() == "") {
                $("#SizeInput").addClass("Error");
                    Error = false;
                }
                else {
                $("#SizeInput").removeClass("Error");
                }
           
            return Error;
        }//Close Validation function

        function ValidateSelect() {
            if ($("#Select1").val() == null) {
                $(".Form-Class").prepend('<div class="alert alert-danger"><strong>Omaiga!</strong> You can insert a farm without conditions >:o </div>');
                return false;
            }
            return true;

        }//Validates the select


    </script>
    <style>
        #hidden {
            display: none;
        }

        #hidden2 {
            display: none;
        }

        #hidden3 {
            display: none;
        }

        .Error {
            border: solid 1px red;
        }
    </style>

    <form role="form" class="Form-Class">
        <div class="form-group">
            <label for="usrname"><span class="glyphicon glyphicon-lock Data"></span>Size</label>
            <input type="text" class="form-control Data NewOne" id="SizeInput" placeholder="Enter Size">
        </div>
        <div class="form-group">
            <label for="usrname"><span class="glyphicon glyphicon-user"></span> Description</label>
            <textarea id="Summernote"></textarea>
        </div>
    </form>

    <input type="text" id="hidden3">
    <div class="form-group">
        <label class="control-label col-md-2">Conditions</label>
        <select class="form-control" id="Select1" multiple></select>
    </div>


    <!------------------------------------------MAIN TABLE------------------------------------------>
    Observation | <span><button id="AddObservationModal" class="btn btn-success btn btn-default glyphicon glyphicon-plus-sign" type="button" onclick="OpenModal()"></button></span>
    <table id="MainTable" class="table table-striped table-bordered" cellspacing="0">
        <thead>
            <tr>
                <th>
                    <label>Description</label>
                </th>
                <th>
                    <label>Buttons</label>
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </br>
    <button class="btn btn-success btn-block" id="EditParcel">Edit Parcel</button>
    <!------------------------------------------MAIN TABLE------------------------------------------>
    <!------------------------------------------MODAL------------------------------------------>
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header" style="padding:35px 50px;">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4><span class="glyphicon glyphicon-add"></span> Add Farm Information :3</h4>
                </div>
                <div class="modal-body ValidationModal" id="modal-body" style="padding:40px 50px;">

                    <form role="form">

                        <div class="form-group">
                            <label for="usrname"><span class="glyphicon glyphicon-user"></span> Description</label>
                            <textarea id="Summernote2"></textarea>
                        </div>
                        <input type="text" id="hidden">
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success btn-block" id="AddObservation"><span class="glyphicon glyphicon-record"></span> Add the Observation</button>
                    <button type="submit" class="btn btn-success btn-block Display" id="EditRow"><span class="glyphicon glyphicon-record"></span> Edit the row</button>
                    <button type="submit" class="btn btn-success btn-block" id="CloseModal" onclick="CloseModal()"><span class="glyphicon glyphicon-remove-circle"></span> Cancel </button>
                </div>
            </div>


        </div>
    </div>
    <!------------------------------------------MODAL------------------------------------------>
    <!------------------------------------DELETE MODAL------------------------------------->
    <div class="modal fade" id="myDeleteModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header" style="padding:35px 50px;">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4><span class="glyphicon glyphicon-add"></span>Delete this row ????</h4>
                </div>
                <div class="modal-body" style="padding:40px 50px;">
                    <div class="alert alert-danger"><strong> Mah gosh </strong>Do you really want to delete this ??</div>
                </div>
                <input id="hidden2" type="text">
                <div class="modal-footer">

                    <button type="submit" class="btn btn-success btn-block Display" id="YesDelete"><span class="glyphicon glyphicon-record"></span>Yes, i want to delete this</button>
                    <button type="submit" class="btn btn-success btn-block" id="NoDelete"><span class="glyphicon glyphicon-remove-circle"></span>No, it was a mistake</button>
                </div>
            </div>


        </div>
    </div>
    <!------------------------------------DELETE MODAL------------------------------------->
    </div>
</body>
</html>
